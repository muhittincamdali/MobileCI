# React Native Android Release Workflow
# Build and deploy React Native Android apps to Google Play Store
# Version: 2.0.0

name: React Native Android Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-android'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.3)'
        required: true
        type: string
      track:
        description: 'Release track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      build_type:
        description: 'Build type'
        required: false
        default: 'aab'
        type: choice
        options:
          - aab
          - apk

concurrency:
  group: rn-android-release
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  RUBY_VERSION: '3.2'

jobs:
  # ===========================================================================
  # VALIDATE
  # ===========================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_code: ${{ steps.version.outputs.version_code }}
      track: ${{ steps.track.outputs.track }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            VERSION="${VERSION%-android}"
          fi
          
          # Validate semantic version
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            exit 1
          fi
          
          VERSION_CODE="${{ github.run_number }}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION ($VERSION_CODE)"
      
      - name: Determine track
        id: track
        run: |
          TRACK="${{ inputs.track }}"
          if [ -z "$TRACK" ]; then
            TRACK="internal"
          fi
          echo "track=$TRACK" >> $GITHUB_OUTPUT

  # ===========================================================================
  # BUILD
  # ===========================================================================
  build:
    name: Build Android
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 45
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      
      - name: Setup keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PROPERTIES: ${{ secrets.ANDROID_KEYSTORE_PROPERTIES }}
        run: |
          # Decode keystore
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/release-keystore.jks
          
          # Create keystore.properties
          echo "$KEYSTORE_PROPERTIES" > android/keystore.properties
      
      - name: Update version
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          VERSION_CODE="${{ needs.validate.outputs.version_code }}"
          
          # Update package.json
          npm version "$VERSION" --no-git-tag-version
          
          # Update build.gradle
          sed -i "s/versionName \".*\"/versionName \"$VERSION\"/" android/app/build.gradle
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
      
      - name: Build App Bundle
        if: ${{ inputs.build_type != 'apk' }}
        run: |
          cd android
          ./gradlew bundleRelease --no-daemon
      
      - name: Build APK
        if: ${{ inputs.build_type == 'apk' }}
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon
      
      - name: Upload App Bundle
        if: ${{ inputs.build_type != 'apk' }}
        uses: actions/upload-artifact@v4
        with:
          name: android-release-aab
          path: android/app/build/outputs/bundle/release/*.aab
          retention-days: 30
      
      - name: Upload APK
        if: ${{ inputs.build_type == 'apk' }}
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30
      
      - name: Upload mapping file
        uses: actions/upload-artifact@v4
        with:
          name: android-mapping
          path: android/app/build/outputs/mapping/release/mapping.txt
          retention-days: 90
          if-no-files-found: ignore

  # ===========================================================================
  # TEST
  # ===========================================================================
  test:
    name: Release Tests
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      
      - name: Run tests
        run: yarn test --ci

  # ===========================================================================
  # DEPLOY
  # ===========================================================================
  deploy:
    name: Deploy to Google Play
    runs-on: ubuntu-latest
    needs: [validate, build, test]
    timeout-minutes: 30
    environment:
      name: production
      url: https://play.google.com/store/apps/details?id=${{ secrets.ANDROID_PACKAGE_NAME }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.build_type == 'apk' && 'android-release-apk' || 'android-release-aab' }}
          path: build/
      
      - name: Setup Google Play credentials
        env:
          GOOGLE_PLAY_JSON_KEY: ${{ secrets.GOOGLE_PLAY_JSON_KEY }}
        run: |
          echo "$GOOGLE_PLAY_JSON_KEY" > google-play-key.json
      
      - name: Generate changelog
        id: changelog
        run: |
          CHANGELOG=$(git log --pretty=format:"â€¢ %s" -10 --no-merges | head -c 500)
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Bug fixes and performance improvements"
          fi
          
          mkdir -p fastlane/metadata/android/en-US/changelogs
          echo "$CHANGELOG" > "fastlane/metadata/android/en-US/changelogs/${{ needs.validate.outputs.version_code }}.txt"
      
      - name: Deploy to Google Play
        env:
          SUPPLY_JSON_KEY: google-play-key.json
          SUPPLY_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME }}
        run: |
          BUILD_FILE=$(find build -name "*.aab" -o -name "*.apk" | head -1)
          TRACK="${{ needs.validate.outputs.track }}"
          
          if [[ "$BUILD_FILE" == *.aab ]]; then
            bundle exec fastlane supply \
              --aab "$BUILD_FILE" \
              --track "$TRACK" \
              --skip_upload_metadata true \
              --skip_upload_images true \
              --skip_upload_screenshots true
          else
            bundle exec fastlane supply \
              --apk "$BUILD_FILE" \
              --track "$TRACK" \
              --skip_upload_metadata true \
              --skip_upload_images true \
              --skip_upload_screenshots true
          fi
      
      - name: Cleanup
        if: always()
        run: rm -f google-play-key.json

  # ===========================================================================
  # POST-RELEASE
  # ===========================================================================
  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create Git tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if ! git rev-parse "v$VERSION-android" >/dev/null 2>&1; then
            git tag -a "v$VERSION-android" -m "Android release v$VERSION"
            git push origin "v$VERSION-android"
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.validate.outputs.version }}-android
          name: Android v${{ needs.validate.outputs.version }}
          body: |
            ## Android Release v${{ needs.validate.outputs.version }}
            
            Version Code: ${{ needs.validate.outputs.version_code }}
            Track: ${{ needs.validate.outputs.track }}
          draft: false
          prerelease: ${{ needs.validate.outputs.track != 'production' }}
      
      - name: Notify Slack
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "React Native Android v${{ needs.validate.outputs.version }} released to ${{ needs.validate.outputs.track }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*React Native Android Release*\n\nVersion: `${{ needs.validate.outputs.version }}`\nVersion Code: `${{ needs.validate.outputs.version_code }}`\nTrack: `${{ needs.validate.outputs.track }}`"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
